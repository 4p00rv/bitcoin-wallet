<!DOCTYPE HTML>
<html>
    <head>
        <title>Bitcoin Wallet | Binary.com</title>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
        <meta name="description" content="Bitcoin Wallet">
        <meta name="keywords" content="bitcoin, wallet, btc">
        <link rel="apple-touch-icon" sizes="57x57" href="https://style.binary.com/images/favicons/apple-touch-icon-57x57.png">
        <link rel="apple-touch-icon" sizes="114x114" href="https://style.binary.com/images/favicons/apple-touch-icon-114x114.png">
        <link rel="apple-touch-icon" sizes="72x72" href="https://style.binary.com/images/favicons/apple-touch-icon-72x72.png">
        <link rel="apple-touch-icon" sizes="144x144" href="https://style.binary.com/images/favicons/apple-touch-icon-144x144.png">
        <link rel="apple-touch-icon" sizes="60x60" href="https://style.binary.com/images/favicons/apple-touch-icon-60x60.png">
        <link rel="apple-touch-icon" sizes="120x120" href="https://style.binary.com/images/favicons/apple-touch-icon-120x120.png">
        <link rel="apple-touch-icon" sizes="76x76" href="https://style.binary.com/images/favicons/apple-touch-icon-76x76.png">
        <link rel="apple-touch-icon" sizes="152x152" href="https://style.binary.com/images/favicons/apple-touch-icon-152x152.png">
        <link rel="apple-touch-icon" sizes="180x180" href="https://style.binary.com/images/favicons/apple-touch-icon-180x180.png">
        <link rel="icon" sizes="192x192" type="image/png" href="https://style.binary.com/images/favicons/favicon-192x192.png">
        <link rel="icon" sizes="160x160" type="image/png" href="https://style.binary.com/images/favicons/favicon-160x160.png">
        <link rel="icon" sizes="96x96" type="image/png" href="https://style.binary.com/images/favicons/favicon-96x96.png">
        <link rel="icon" sizes="16x16" type="image/png" href="https://style.binary.com/images/favicons/favicon-16x16.png">
        <link rel="icon" sizes="32x32" type="image/png" href="https://style.binary.com/images/favicons/favicon-32x32.png">
        <link rel="stylesheet" href="common.css">
        <link rel="stylesheet" href="https://style.binary.com/binary.css">
        <script language='JavaScript' type='text/javascript' src='common.js'></script>
        <script language='JavaScript' type='text/javascript' src='hashes.js'></script>
        <script language='JavaScript' type='text/javascript' src='jsbn.js'></script>
        <script language='JavaScript' type='text/javascript' src='elliptic.js'></script>
        <script language='JavaScript' type='text/javascript' src='btc.js'></script>
        <script language='JavaScript' type='text/javascript' src='backend_bci.js'></script>
    </head>
    <body>
        <div id="header-binary">
            <a href="https://www.binary.com">
                <img id="symbol-logo" src="https://style.binary.com/images/logo/symbol.svg" alt="" />
                <img id="type-logo" src="https://style.binary.com/images/logo/type.svg" alt="Binary.com" />
            </a>
        </div>

        <div id="container">
            <div id="content" class="center-text">
                <img src="images/bitcoin_wallet.svg" />
                <h1>Bitcoin Wallet</h1>
                <p>With Bitcoin Wallet you can send bitcoin to Binary.com or anyone else in the world.</p>

                <form id="pass_form" action="javascript:open_wallet();">
                    <input id="passphrase" type="password" placeholder="Passphrase" title="Can also use compressed WIF key.">
                    <button type="submit">Open</button>
                </form>

                <form id="send_form" action="javascript:send_tx();">
                    <div class="left-text">
                        <span id="close" onclick="location.reload()" title="sign out">X</span>
                        <span id="adr"></span>
                        <h2 id="balance">Balance: </h2>
                        <span id="transactions"></span>
                        <div>
                            <input id="to" type="text" placeholder="Address">
                            <input id="amount" type="text" placeholder="Amount">
                            <button type="submit">Send</button>
                        </div>
                    </div>
                    <div id="status"></div>
                </form>

                <p>
                    Nothing is sent to our server, everything is done in the browser.
                    <br>
                    It gets utxo and sends signed txs via <span id="backend"></span> API.
                </p>
                <p>You can download it from <a href="https://github.com/binary-com/bitcoin-wallet" target="_blank">github</a> and use it locally.</p>
            </div>
        </div>

        <script>
            var tx, keys, fee = 0.0001;

            function balance_cb(amount) {
                if (isNaN(amount)) amount = '?'; else amount = js.format_money(amount, 8);

                $('balance').innerHTML = "<span title='click to refresh' onclick='refresh(true);' style='cursor:pointer'>Balance: <b id=amt>" + amount + "</b> BTC</span>";
                $('transactions').innerHTML = "<a class='button-secondary' href='" + backend.adr_page + keys.adr + "' target=_blank><span>transactions</span></a>";
            }

            function refresh(set_amount) {
                if (set_amount) $('amt').innerHTML = '?';

                backend.get_balance(keys.adr, balance_cb);
            }

            function open_wallet() {
                var pass = js.trim($('passphrase').value);
                if (pass.length < 1) return;

                keys = btc.get_keys(pass);

                $('pass_form').hide();
                $('send_form').show();
                $('to').focus();

                $('adr').innerHTML = "<b style='font-size:16px'>" + keys.adr + "</b>&ndash;[<a href='javascript:show_wif()'>wif</a>]&ndash;<br><span id=wif></span>";

                refresh();
                setInterval(refresh, 60000);
            }

            function show_wif() {
                $('wif').innerHTML = ($('wif').innerHTML == '' ? keys.wif : '');
            }

            function broadcast_cb(res) {
                if (res == '') {
                    $('to').value = '';
                    $('amount').value = '';
                    $('status').innerHTML = '<a href="https://blockchain.info/tx/' + tx.txid() + '" target=_blank>Transaction</a> sent.';
                }
                else $('status').innerHTML = 'Error: ' + res;

                tx = null;
                js.enable_form('send_form', true);
                setTimeout(refresh, 1000);
            }

            function broadcast() {
                $('status').innerHTML = 'Signing tx...';

                var signed = tx.sign(keys);

                $('status').innerHTML = 'Broadcasting...';

                backend.send(signed, broadcast_cb);
            }

            function unspent_cb(utxo) {
                if (utxo !== false) {
                    var total = tx.add_unspent(utxo), err = '';

                    var tx_total = tx.amount + fee;

                    if (total >= tx_total) {
                        var change = total - tx_total;

                        if (change > 0.000001) tx.add_output(keys.adr, change);

                        setTimeout(broadcast, 300);

                        return;
                    }
                    else err = 'Not enough money! Need ' + js.format_money(tx_total - total, 8) + ' BTC more.';
                }
                else err = 'Failed to get unspent outputs!';

                tx = null;
                js.enable_form('send_form', true);
                $('status').innerHTML = err;
            }

            function send_tx() {
                var dst = js.trim($('to').value), amount = parseFloat(js.trim($('amount').value));

                if (dst == '' || btc.decode_adr(dst) === false || isNaN(amount) || amount < 0.0001) return;

                if (confirm('Send ' + amount + ' BTC to ' + dst + '?')) {
                    tx = btc.new_tx();

                    tx.add_output(dst, amount);

                    js.enable_form('send_form', false);

                    $('status').innerHTML = 'Getting unspent outputs...';

                    backend.get_utxo(keys.adr, unspent_cb);
                }
            }

            if (!JSON || !JSON.parse) alert("Your browser doesn't support native JSON decoding. This page will not work, sorry.");
            else {
                var x = new XMLHttpRequest();

                if ('withCredentials' in x) {
                    $('backend').innerHTML = backend.link;
                    $('pass_form').show();
                    $('passphrase').focus();
                }
                else alert("Your browser dosen't support Cross-Origin Resource Sharing. This page will not work, sorry.");
            }
        </script>
    </body>
</html>
